<!DOCTYPE html>
<html lang="zh" dir="ltr">

<!-- Mirrored from wiki.wooyun.org/_export/xhtml/server:mssql by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 04 Dec 2015 03:02:53 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <meta charset="utf-8" />
  <title>server:mssql</title>
<meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="keywords" content="server,mssql"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../lib/exe/opensearch.php" title="WooYun WiKi"/>
<link rel="start" href="../../index.html"/>
<link rel="contents" href="../../server_mssqldecf.html?do=index" title="网站地图"/>
<link rel="alternate" type="application/rss+xml" title="最近更改" href="../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="当前命名空间" href="../../feed0688.php?mode=list&amp;ns=server"/>
<link rel="alternate" type="text/html" title="纯HTML" href="server_mssql.html"/>
<link rel="alternate" type="text/plain" title="Wiki Markup 语言" href="../raw/mssql.txt"/>
<link rel="canonical" href="../../server_mssql.html"/>
<link rel="stylesheet" type="text/css" href="../../lib/exe/css70b4.css?t=bootstrap3&amp;tseed=6dcbf66232c3759c28d0e8f6d9cdfd22"/>
<script type="text/javascript">/*<![CDATA[*/var NS='server';var JSINFO = {"id":"server:mssql","namespace":"server","plugin_codeprettify":{"loader_base":"\/lib\/plugins\/codeprettify\/google-code-prettify"}};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../lib/exe/js1e16.php?tseed=6dcbf66232c3759c28d0e8f6d9cdfd22"></script>
<script type="text/javascript" charset="utf-8" src="../../lib/plugins/codeprettify/google-code-prettify/run_prettifyeb11.js?lang=css"></script>
</head>
<body>
<div class="dokuwiki export">
<!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">目录</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="#mssql安全配置">MSSQL安全配置</a></div>
<ul class="toc">
<li class="clear">
<ul class="toc">
<li class="level3"><div class="li"><a href="#mssql简介">1、MSSQL简介</a></div></li>
<li class="level3"><div class="li"><a href="#mssql服务器架设">2、MSSQL服务器架设</a></div></li>
<li class="level3"><div class="li"><a href="#错误配置及利用">3、错误配置及利用</a></div></li>
<li class="level3"><div class="li"><a href="#实际案例">4、实际案例</a></div></li>
<li class="level3"><div class="li"><a href="#修复方案">5、修复方案</a></div></li>
<li class="level3"><div class="li"><a href="#漏洞扫描及发现">6、漏洞扫描及发现</a></div></li>
<li class="level3"><div class="li"><a href="#相关资源">7、相关资源</a></div></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1" id="mssql安全配置">MSSQL安全配置</h1>
<div class="level1">

</div>
<!-- EDIT1 SECTION "MSSQL安全配置" [1-33] -->
<h3 class="sectionedit2" id="mssql简介">1、MSSQL简介</h3>
<div class="level3">
<hr />

<p>
Microsoft SQL Server是由美国微软公司所推出的关系数据库解决方案。 数据库的内置语言原本是采用美国标准局（ANSI）和国际标准组织（ISO）所定义的SQL语言，但是微软公司对它进行了部分扩充而成为作业用SQL（Transact-SQL）。 
</p>

<p>
SQL Server一开始并不是微软自己研发的产品，而是当时为了要和IBM竞争时，与Sybase合作所产生的，其最早的发展者是Sybase，同时微软也和Sybase合作过SQL Server 4.2版本的研发，微软亦将SQL Server 4.2移植到Windows NT（当时为3.1版），在与Sybase终止合作关系后，自力开发出SQL Server 6.0版，往后的SQL Server即均由微软自行研发。
</p>

<p>
在与微软终止合作关系后，Sybase在Windows NT上的数据库产品原本称为Sybase SQL Server，后来改为现在的Sybase Adaptive Server Enterprise。
</p>

</div>
<!-- EDIT2 SECTION "1、MSSQL简介" [34-944] -->
<h3 class="sectionedit3" id="mssql服务器架设">2、MSSQL服务器架设</h3>
<div class="level3">
<hr />

<p>
Mssql试用版的下载地址可在<a href="https://www.microsoft.com/zh-cn/server-cloud/products/sql-server/Try.aspx" class="urlextern" title="https://www.microsoft.com/zh-cn/server-cloud/products/sql-server/Try.aspx"  rel="nofollow">Mssql试用版官方下载地址</a>找到。
</p>

<p>
Mssql的安装有使用安装向导进行安装还有使用命令行进行安装两种方法，具体安装方法请参见官方文档。
</p>

<p>
使用安装向导的请参见<a href="https://technet.microsoft.com/zh-cn/library/ms143219(v=sql.110)" class="urlextern" title="https://technet.microsoft.com/zh-cn/library/ms143219(v=sql.110)"  rel="nofollow">使用安装向导安装 SQL Server 2012（安装程序）</a>。
</p>

<p>
使用命令行进行安装请参见<a href="https://technet.microsoft.com/zh-cn/library/ms144259(v=sql.110)" class="urlextern" title="https://technet.microsoft.com/zh-cn/library/ms144259(v=sql.110)"  rel="nofollow">从命令提示符安装 SQL Server 2012</a>。
</p>

</div>
<!-- EDIT3 SECTION "2、MSSQL服务器架设" [945-1591] -->
<h3 class="sectionedit4" id="错误配置及利用">3、错误配置及利用</h3>
<div class="level3">
<hr />

<p>
<strong>使用了旧版本的Mssql</strong>
</p>

<p>
Mssql并不是一款免费的数据库解决方案，许多网站所使用的都不是最新版本的Mssql数据库，这些旧版本中存在着许多公开的漏洞，威胁着服务器的安全。
</p>

<p>
<strong>sa用户弱口令且Mssql端口对外开放</strong>
</p>

<p>
Mssql默认端口为1433端口，当该端口对外开放时，攻击者便可尝试对Mssql的账号密码进行爆破，此时若服务器使用了常用的用户名（如administrator）或默认用户名（Mssql默认用户为sa）且密码为弱口令或者默认的空口令则极易造成服务器被攻击者登陆，并进一步利用。参考<a href="http://drops.wooyun.org/tips/1620" class="urlextern" title="http://drops.wooyun.org/tips/1620"  rel="nofollow">MSSQL注射知识库 v 1.0</a>中MSSQL 2000密码破解部分的内容。在攻击者获取到Mssql服务器数据库操作权限的时候服务器中缺少对用户权限的限制就极易导致服务器沦陷，参考<a href="http://drops.wooyun.org/tips/1620" class="urlextern" title="http://drops.wooyun.org/tips/1620"  rel="nofollow">MSSQL注射知识库 v 1.0</a>中Get WebShell和系统命令执行部分的内容。
</p>

<p>
<strong>启用了xp_cmdshell等危险扩展命令</strong>
</p>

<p>
Mssql中有许多类似于xp_cmdshell的扩展命令，当攻击者获取到Mssql的数据库操作权限时，这些扩展命令非常容易被攻击者利用，最终导致服务器沦陷。因此，在使用Mssql时应尽量禁用这些扩展命令。常被利用的扩展命令有
</p>
<pre class="code">Sp_OACreate
Sp_OADestroy
Sp_OAGetErrorInfo
Sp_OAGetProperty
Sp_OAMethod
Sp_OASetProperty
Sp_OAStop
Xp_regaddmultistring
Xp_regdeletekey
Xp_regdeletevalue
Xp_regenumvalues
Xp_regremovemultistring
xp_sdidebug
xp_availablemedia
xp_cmdshell
xp_deletemail
xp_dirtree
xp_dropwebtask
xp_dsninfo
xp_enumdsn
xp_enumerrorlogs
xp_enumgroups
xp_enumqueuedtasks
xp_eventlog
xp_findnextmsg
xp_fixeddrives
xp_getfiledetails
xp_getnetname
xp_grantlogin
xp_logevent
xp_loginconfig
xp_logininfo
xp_makewebtask
xp_msver
xp_perfend
xp_perfmonitor
xp_perfsample
xp_perfstart
xp_readerrorlog
xp_readmail
xp_revokelogin
xp_runwebtask
xp_schedulersignal
xp_sendmail
xp_servicecontrol
xp_snmp_getstate
xp_snmp_raisetrap
xp_sprintf
xp_sqlinventory
xp_sqlregister
xp_sqltrace
xp_sscanf
xp_startmail
xp_stopmail
xp_subdirs
xp_unc_to_drive
xp_dirtree</pre>

<p>
以下是使用xp_cmdshell执行系统命令的示例：
</p>
<pre class="code">exec xp_cmdshell &#039;whoami&#039;</pre>

</div>
<!-- EDIT4 SECTION "3、错误配置及利用" [1592-3911] -->
<h3 class="sectionedit5" id="实际案例">4、实际案例</h3>
<div class="level3">
<hr />

<p>
<a href="http://www.wooyun.org/bugs/wooyun-2015-0104036" class="urlextern" title="http://www.wooyun.org/bugs/wooyun-2015-0104036"  rel="nofollow">四川烟草网MSSQL遇SA权限能执行0S-SHELL成功提权服务器（可内网渗透）</a>
</p>

<p>
<a href="http://www.wooyun.org/bugs/wooyun-2014-061080" class="urlextern" title="http://www.wooyun.org/bugs/wooyun-2014-061080"  rel="nofollow">用友协作办公平台再次通杀SQL注入</a>
</p>

<p>
<a href="http://www.wooyun.org/bugs/wooyun-2010-0109828" class="urlextern" title="http://www.wooyun.org/bugs/wooyun-2010-0109828"  rel="nofollow">青岛科技大学某系统后台post注入</a>
</p>

</div>
<!-- EDIT5 SECTION "4、实际案例" [3912-4280] -->
<h3 class="sectionedit6" id="修复方案">5、修复方案</h3>
<div class="level3">

<p>
<strong>使用了旧版本的Mssql</strong>
</p>

<p>
升级Mssql，或者使用其他的数据库解决方案。
</p>

<p>
<strong>sa用户弱口令且Mssql端口对外开放</strong>
</p>
<pre class="code sql">#查看口令为空的用户 
<span class="kw1">SELECT</span> <span class="sy0">*</span> <span class="kw1">FROM</span> sysusers
<span class="kw1">SELECT</span> name<span class="sy0">,</span>Password <span class="kw1">FROM</span> syslogins <span class="kw1">WHERE</span> password <span class="kw1">IS</span> <span class="kw1">NULL</span> <span class="kw1">ORDER</span> <span class="kw1">BY</span> name
&nbsp;
#更改口令
<span class="kw1">USE</span> master <span class="kw1">EXEC</span> sp_password ‘旧口令’，‘新口令’<span class="sy0">,</span>用户名</pre>

<p>
管理用户权限：
</p>
<ol>
<li class="level1"><div class="li"> 企业管理器-〉数据库-〉对应数据库-〉角色-中创建新角色；</div>
</li>
<li class="level1"><div class="li"> 调整角色属性中的权限，赋予角色中拥有对象对应的SELECT、INSERT、UPDATE、DELETE、EXEC、DRI权限</div>
</li>
</ol>

<p>
<strong>启用了xp_cmdshell等危险扩展命令</strong>
</p>
<pre class="code sql">#删除xp_cmdshell扩展命令，删除其它扩展命令同理
<span class="kw1">USE</span> master  sp_dropextendedproc <span class="st0">'xp_cmdshell'</span> </pre>

</div>
<!-- EDIT6 SECTION "5、修复方案" [4281-5095] -->
<h3 class="sectionedit7" id="漏洞扫描及发现">6、漏洞扫描及发现</h3>
<div class="level3">

<p>
Mssql默认端口为1433，当数据库允许远程连接时该端口会对外开放。 通过对1433端口进行扫描就可以找到对外开放的Mssql服务器。
</p>
<pre class="code bash"><span class="sy0">//</span>扫描
<span class="kw2">nmap</span> <span class="re5">-n</span> <span class="re5">--open</span> <span class="re5">-p</span> <span class="nu0">1433</span> X.X.X.X<span class="sy0">/</span><span class="nu0">24</span>
&nbsp;
<span class="sy0">//</span>使用<span class="kw2">nmap</span>进行暴力破解
<span class="kw2">nmap</span> <span class="re5">-p1433</span> <span class="re5">--script</span>=ms-sql-brute <span class="re5">--script-args</span>=<span class="re2">userdb</span>=<span class="sy0">/</span>var<span class="sy0">/</span><span class="kw2">passwd</span>,<span class="re2">passdb</span>=<span class="sy0">/</span>var<span class="sy0">/</span><span class="kw2">passwd</span> 192.168.5.1</pre>

<p>
找到开放1433端口的服务器后便可尝试用Mssql数据库管理工具进行连接。
</p>

</div>
<!-- EDIT7 SECTION "6、漏洞扫描及发现" [5096-5585] -->
<h3 class="sectionedit8" id="相关资源">7、相关资源</h3>
<div class="level3">
<hr />

<p>
<a href="https://www.microsoft.com/zh-cn/server-cloud/products/sql-server/Try.aspx" class="urlextern" title="https://www.microsoft.com/zh-cn/server-cloud/products/sql-server/Try.aspx"  rel="nofollow">Mssql试用版官方下载地址</a>
</p>

<p>
<a href="https://technet.microsoft.com/zh-cn/library/ms143219(v=sql.110)" class="urlextern" title="https://technet.microsoft.com/zh-cn/library/ms143219(v=sql.110)"  rel="nofollow">使用安装向导安装 SQL Server 2012（安装程序）</a>
</p>

<p>
<a href="https://technet.microsoft.com/zh-cn/library/ms144259(v=sql.110)" class="urlextern" title="https://technet.microsoft.com/zh-cn/library/ms144259(v=sql.110)"  rel="nofollow">从命令提示符安装 SQL Server 2012</a>
</p>

<p>
<a href="http://drops.wooyun.org/tips/1670" class="urlextern" title="http://drops.wooyun.org/tips/1670"  rel="nofollow">SQL SERVER 2008安全配置</a>
</p>

<p>
<a href="http://drops.wooyun.org/tips/1620" class="urlextern" title="http://drops.wooyun.org/tips/1620"  rel="nofollow">MSSQL注射知识库 v 1.0</a>
</p>

</div>
<!-- EDIT8 SECTION "7、相关资源" [5586-] --></div>
</body>

<!-- Mirrored from wiki.wooyun.org/_export/xhtml/server:mssql by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 04 Dec 2015 03:02:53 GMT -->
</html>
